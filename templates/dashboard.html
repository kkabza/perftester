<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOO CLI Performance Tester - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .bg-custom-lime {
            background-color: #D7DF21 !important;
        }
        
        /* Enhanced input and select styles */
        input[type="text"],
        input[type="number"],
        input[type="password"],
        select {
            border: 2px solid #cbd5e1 !important;
            background-color: white !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        select:focus {
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2) !important;
        }

        /* Darker text for better readability */
        input::placeholder {
            color: #94a3b8 !important;
        }

        /* Ensure select boxes have consistent height and padding */
        select {
            padding: 0.5rem !important;
            height: 2.5rem !important;
        }
    </style>
</head>
<body class="bg-gray-200 min-h-screen">
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <div class="w-64 bg-custom-lime text-gray-800">
            <div class="p-4 flex flex-col h-full">
                <!-- Logo Section -->
                <div class="h-24 mb-4">
                    <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="MOO Logo" class="h-full w-auto mx-auto object-contain">
                </div>
                
                <!-- User Info Section -->
                <div class="mb-4 p-2 bg-white/80 rounded">
                    <h2 class="text-lg font-semibold">MOO Commands</h2>
                    <p class="text-sm text-gray-700">Welcome, {{ username }}</p>
                    <p class="text-xs text-gray-600">Role: {{ role }}</p>
                </div>

                <!-- Navigation -->
                <nav class="space-y-2">
                    <button onclick="showSection('login')" class="w-full text-left p-2 hover:bg-gray-200 hover:text-black rounded text-gray-800 transition-colors" id="nav-login">
                        Login/Logout
                    </button>
                    <button onclick="showSection('ls')" class="w-full text-left p-2 hover:bg-gray-200 hover:text-black rounded text-gray-800 transition-colors" id="nav-ls">
                        moo ls
                    </button>
                    <button onclick="showSection('get')" class="w-full text-left p-2 hover:bg-gray-200 hover:text-black rounded text-gray-800 transition-colors" id="nav-get">
                        moo get
                    </button>
                    <button onclick="showSection('si')" class="w-full text-left p-2 hover:bg-gray-200 hover:text-black rounded text-gray-800 transition-colors" id="nav-si">
                        moo si
                    </button>
                    <button onclick="showSection('put')" class="w-full text-left p-2 hover:bg-gray-200 hover:text-black rounded text-gray-800 transition-colors" id="nav-put">
                        moo put
                    </button>
                    <button onclick="showSection('projinfo')" class="w-full text-left p-2 hover:bg-gray-200 hover:text-black rounded text-gray-800 transition-colors" id="nav-projinfo">
                        moo projinfo
                    </button>
                    <button onclick="showSection('appinsights')" class="w-full text-left p-2 hover:bg-gray-200 hover:text-black rounded text-gray-800 transition-colors" id="nav-appinsights">
                        App Insights Search
                    </button>
                </nav>
            </div>
        </div>
        
        <!-- Main content -->
        <div class="flex-1 overflow-auto bg-gray-200">
            <div class="p-8">
                <!-- Header with logout -->
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold" id="section-title">MOO CLI Performance Tester</h2>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">Logged in as: {{ username }}</span>
                        <button onclick="logout()" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">
                            Logout
                        </button>
                    </div>
                </div>
                
                <!-- Performance Test Controls -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4">Performance Test Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Number of Iterations</label>
                            <input type="number" id="iterations" value="10" min="1" max="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Delay Between Runs (ms)</label>
                            <input type="number" id="delay" value="100" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="useSudo" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span class="ml-2 text-sm text-gray-600">Run with sudo</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Project Info Command Section -->
                <div id="projinfo-section" class="mb-6" style="display: none;">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-semibold mb-4">MOO Projinfo Command</h3>
                        <div class="space-y-4">
                            <!-- Project Names Input -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Project Names</label>
                                <div class="flex items-center space-x-2">
                                    <input type="text" id="projinfoProjectNames" 
                                           class="flex-1 rounded-md border-gray-300 shadow-sm px-4 py-2 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Enter project names (space-separated)">
                                    <button onclick="addProjectName()" 
                                            class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        Add
                                    </button>
                                </div>
                                <div id="projectNamesList" class="mt-2 space-y-1">
                                    <!-- Project names will be added here -->
                                </div>
                            </div>

                            <!-- Command Options -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="projinfoLong" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                    <span class="ml-2 text-sm text-gray-700">Long format (-l)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="projinfoMembers" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                    <span class="ml-2 text-sm text-gray-700">Show members (-m)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="projinfoXml" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                    <span class="ml-2 text-sm text-gray-700">XML output (-x)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="projinfoDryRun" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                    <span class="ml-2 text-sm text-gray-700">Dry run (-n)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="projinfoQuiet" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                    <span class="ml-2 text-sm text-gray-700">Quiet (-q)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="projinfoVerbose" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                    <span class="ml-2 text-sm text-gray-700">Verbose (-v)</span>
                                </label>
                            </div>

                            <!-- Act As Role -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Act As Role (Optional)</label>
                                <input type="text" id="projinfoActAs" 
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                       placeholder="Enter role name">
                            </div>

                            <!-- Command Preview -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Command Preview</label>
                                <div id="commandPreview" class="bg-gray-100 p-3 rounded-md font-mono text-sm text-gray-400">
                                    moo projinfo
                                </div>
                            </div>

                            <!-- Execute Buttons -->
                            <div class="flex justify-end space-x-4">
                                <button onclick="runPerformanceTest(executeProjinfoCommand)" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
                                    Run Performance Test
                                </button>
                                <button onclick="executeProjinfoCommand()" id="projinfoCommandBtn"
                                        class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 relative">
                                    <span>Execute Command</span>
                                    <span id="projinfoCommandLoading" class="absolute inset-0 flex items-center justify-center hidden">
                                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Login Section -->
                <div id="login-section" class="space-y-6 mb-6" style="display: block;">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-semibold mb-4">MOO Login Options</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Username</label>
                                    <input type="text" id="mooUsername" value="abbia@supercomputing2020dev.onmicrosoft.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Password</label>
                                    <input type="password" id="mooPassword" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Login Options</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="deviceCode" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <span class="ml-2 text-sm text-gray-600">Device Code (-d)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="interactive" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <span class="ml-2 text-sm text-gray-600">Interactive (-i)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="managedIdentity" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <span class="ml-2 text-sm text-gray-600">Managed Identity (-m)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="servicePrincipal" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <span class="ml-2 text-sm text-gray-600">Service Principal (-s)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="refresh" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <span class="ml-2 text-sm text-gray-600">Refresh (-r)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-4">
                            <button onclick="mooLogin()" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">
                                Execute MOO Login
                            </button>
                            <button onclick="mooLogout()" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700">
                                Execute MOO Logout
                            </button>
                        </div>
                    </div>
                </div>

                <!-- LS Command Section -->
                <div id="ls-section" class="space-y-6 mb-6" style="display: none;">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-semibold mb-4">MOO LS Command</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">MOOSE URI</label>
                                <input type="text" id="mooseUri" value=":/test" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="lsAccessTime" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Access Time (-u)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="lsAll" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">All (-a)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="lsDirectory" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Directory (-d)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="lsFull" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Full (-f)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="lsMedia" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Media (-m)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="lsRecursive" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Recursive (-r)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="lsRegex" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Regex</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="lsSize" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Size (-S)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="lsTime" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Time (-t)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="lsViewMetadata" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">View Metadata (-v)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="lsXml" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">XML (-x)</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Page Range (Optional)</label>
                                <input type="text" id="lsPage" placeholder="e.g., 12-18:12" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <button onclick="executeLsCommand()" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 relative" id="lsCommandBtn">
                                <span>Execute LS Command</span>
                                <span class="hidden absolute inset-0 flex items-center justify-center bg-green-600" id="lsCommandLoading">
                                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </span>
                            </button>
                            <button onclick="runPerformanceTest(executeLsCommand)" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
                                Run Performance Test
                            </button>
                        </div>
                    </div>
                </div>

                <!-- GET Command Section -->
                <div id="get-section" class="space-y-6 mb-6" style="display: none;">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-semibold mb-4">MOO GET Command</h3>
                        
                        <!-- Add Tab Navigation -->
                        <div class="border-b border-gray-200 mb-4">
                            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                                <button onclick="switchGetTab('files')" class="px-3 py-2 text-sm font-medium border-b-2 border-indigo-500 text-indigo-600" id="files-tab">
                                    Files
                                </button>
                                <button onclick="switchGetTab('folders')" class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" id="folders-tab">
                                    Folders
                                </button>
                            </nav>
                        </div>

                        <!-- Files Tab Content -->
                        <div id="files-content" class="space-y-4">
                            <!-- Size-based Selection -->
                            <div id="size-based-selection" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">File Type</label>
                                        <select id="fileType" onchange="handleFileTypeChange()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                            <option value="nc">NetCDF (.nc)</option>
                                            <option value="file">Binary (.file)</option>
                                            <option value="pp-high">PP High Compression (.pp)</option>
                                            <option value="pp-medium">PP Medium Compression (.pp)</option>
                                            <option value="pp-low">PP Low Compression (.pp)</option>
                                            <option value="tar-high">TAR High Compression (.tar)</option>
                                            <option value="tar-medium">TAR Medium Compression (.tar)</option>
                                            <option value="tar-low">TAR Low Compression (.tar)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">File Size</label>
                                        <select id="fileSize" onchange="updateMooseUri()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                            <option value="">Select a size...</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700">Size Type</label>
                                        <div class="mt-1">
                                            <label class="inline-flex items-center mr-4">
                                                <input type="radio" name="sizeType" value="exact" checked onchange="updateMooseUri()" class="rounded-full border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                <span class="ml-2 text-sm text-gray-600">Exact</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="sizeType" value="approx" onchange="updateMooseUri()" class="rounded-full border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                <span class="ml-2 text-sm text-gray-600">Approximate</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Count-based Selection -->
                            <div id="count-based-selection" class="space-y-4 hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">File Type</label>
                                        <select id="countFileType" onchange="handleCountBasedChange()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                            <option value="nc">NetCDF (.nc)</option>
                                            <option value="file">Binary (.file)</option>
                                            <option value="pp">PP (.pp)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">File Count</label>
                                        <select id="fileCount" onchange="handleCountBasedChange()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                            <option value="1">1 File</option>
                                            <option value="10">10 Files</option>
                                            <option value="100">100 Files</option>
                                            <option value="1000">1,000 Files</option>
                                            <option value="10000">10,000 Files</option>
                                            <option value="100000">100,000 Files</option>
                                            <option value="1000000">1,000,000 Files</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Folders Tab Content -->
                        <div id="folders-content" class="space-y-4 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Folder Type</label>
                                    <select id="folderType" onchange="handleFolderTypeChange()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                        <option value="nc">NetCDF (.nc)</option>
                                        <option value="file">Binary (.file)</option>
                                        <option value="pp">PP (.pp)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">File Count</label>
                                    <select id="folderFileCount" onchange="handleFolderTypeChange()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                        <option value="1">1 File</option>
                                        <option value="10">10 Files</option>
                                        <option value="100">100 Files</option>
                                        <option value="1000">1,000 Files</option>
                                        <option value="10000">10,000 Files</option>
                                        <option value="100000">100,000 Files</option>
                                        <option value="1000000">1,000,000 Files</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">MOOSE URI</label>
                                <input type="text" id="getMooseUri" value="moose:/test/core/files/files.file/file-1-mib-exact.file" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Destination Path</label>
                                <input type="text" id="getDestPath" value="/home/kkabza/cli/test" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="getAppend" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Append (-a)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="getCompressed" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Compressed Transfer (-z)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="getFillGaps" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Fill Gaps (-i)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="getFillGapsOverwrite" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Fill Gaps & Overwrite (-I)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="getForce" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Force (-f)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="getIfAvailable" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Get If Available (-g)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="getLargeRetrieval" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Large Retrieval (-b)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="getRegex" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Regex</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">License File Path (Optional)</label>
                                <input type="text" id="getLicenseFile" placeholder="Path to license file" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <button onclick="executeGetCommand()" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 relative" id="getCommandBtn">
                                <span>Execute GET Command</span>
                                <span class="hidden absolute inset-0 flex items-center justify-center bg-green-600" id="getCommandLoading">
                                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </span>
                            </button>
                            <button onclick="runPerformanceTest(executeGetCommand)" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
                                Run Performance Test
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SI Command Section -->
                <div id="si-section" class="space-y-6 mb-6" style="display: none;">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-semibold mb-4">MOO SI Command</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="siLong" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Long/Verbose (-l)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="siXml" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">XML (-x)</span>
                                </label>
                            </div>
                            <button onclick="executeSiCommand()" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 relative" id="siCommandBtn">
                                <span>Execute SI Command</span>
                                <span class="hidden absolute inset-0 flex items-center justify-center bg-green-600" id="siCommandLoading">
                                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </span>
                            </button>
                            <button onclick="runPerformanceTest(executeSiCommand)" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
                                Run Performance Test
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PUT Command Section -->
                <div id="put-section" class="space-y-6 mb-6" style="display: none;">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-semibold mb-4">MOO PUT Command</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Source Path(s)</label>
                                <input type="text" id="putSourcePath" value="./Downloads/file-00000001.pp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <p class="mt-1 text-sm text-gray-500">Can be a file path or wildcard pattern (e.g., ./dir1/*)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Destination MOOSE URI</label>
                                <input type="text" id="putDestUri" value=":/test/core/upload/put-09998.pp/put-file-00000002.pp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="putCompressed" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Compressed Transfer (-z)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="putForce" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Force (-f)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="putForceExcludingIdentical" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Force Excluding Identical (-F)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="putDryRun" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Dry Run</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="putQuiet" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Quiet</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="putVerbose" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Verbose (-v)</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Transfer Threads (Optional)</label>
                                <input type="number" id="putTransferThreads" placeholder="Maximum number of concurrent FTP threads" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Act As Role (Optional)</label>
                                <input type="text" id="putActAs" placeholder="Role name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <button onclick="executePutCommand()" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 relative" id="putCommandBtn">
                                <span>Execute PUT Command</span>
                                <span class="hidden absolute inset-0 flex items-center justify-center bg-green-600" id="putCommandLoading">
                                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </span>
                            </button>
                            <button onclick="runPerformanceTest(executePutCommand)" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
                                Run Performance Test
                            </button>
                        </div>
                    </div>
                </div>

                <!-- App Insights Search Section -->
                <div id="appinsights-section" class="space-y-6 mb-6" style="display: none;">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-semibold mb-4">Azure App Insights Command Search</h3>
                        <div class="space-y-4">
                            <div class="form-group">
                                <label for="apiKey">App Insights API Key:</label>
                                <input type="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" id="apiKey" placeholder="Enter your API key">
                            </div>
                            <div class="form-group">
                                <label for="appId">Application ID:</label>
                                <input type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" id="appId" value="b1a6e0c7-3049-45ef-8323-ef54fab6f5a2" placeholder="Enter your Application ID">
                            </div>
                            <div class="form-group">
                                <label for="commandId">Search Query:</label>
                                <input type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" id="commandId" value="3bae8141-c165-4e56-a6c1-68bc92105064" placeholder="Enter text to search for">
                                <p class="mt-1 text-sm text-gray-500">Enter any text to search for in App Insights (traces, requests, etc.)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Time Range</label>
                                <select id="timeRange" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    <option value="1h">Last Hour</option>
                                    <option value="24h" selected>Last 24 Hours</option>
                                    <option value="7d">Last 7 Days</option>
                                    <option value="30d">Last 30 Days</option>
                                </select>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Search In:</label>
                                <div class="space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="searchTraces" class="rounded border-gray-300 text-indigo-600" checked>
                                        <span class="ml-2">Traces</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="searchRequests" class="rounded border-gray-300 text-indigo-600" checked>
                                        <span class="ml-2">Requests</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="searchDependencies" class="rounded border-gray-300 text-indigo-600" checked>
                                        <span class="ml-2">Dependencies</span>
                                    </label>
                                </div>
                            </div>
                            <button onclick="searchAppInsights()" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 relative" id="searchButton">
                                <span>Search Command</span>
                                <span class="hidden absolute inset-0 flex items-center justify-center bg-blue-600" id="searchSpinner">
                                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </span>
                            </button>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="searchResults" class="bg-white rounded-lg shadow-md p-6 hidden">
                        <h3 class="text-xl font-semibold mb-4">Search Results</h3>
                        <div class="space-y-4">
                            <div id="commandDetails" class="space-y-2">
                                <!-- Command details will be populated here -->
                            </div>
                            <div id="commandTimeline" class="space-y-2">
                                <!-- Timeline will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Results -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4">Performance Results</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Average Response Time</label>
                            <p class="mt-1 text-2xl font-semibold text-indigo-600" id="avgResponseTime">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Min Response Time</label>
                            <p class="mt-1 text-2xl font-semibold text-green-600" id="minResponseTime">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Max Response Time</label>
                            <p class="mt-1 text-2xl font-semibold text-red-600" id="maxResponseTime">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Success Rate</label>
                            <p class="mt-1 text-2xl font-semibold text-blue-600" id="successRate">-</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="h-64">
                            <canvas id="responseTimeChart"></canvas>
                        </div>
                        <div class="h-64">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Command Preview -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4">Command Preview</h3>
                    <div id="commandPreview" class="bg-gray-100 p-3 rounded-md font-mono text-sm text-gray-400">
                        moo command
                    </div>
                </div>

                <!-- Latest Output -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Latest Output</h3>
                        <div class="flex space-x-2">
                            <button onclick="clearResults()" class="bg-gray-500 text-white py-1 px-3 rounded-md hover:bg-gray-600 text-sm">
                                Clear Results
                            </button>
                            <button id="stopButton" onclick="stopTest()" class="bg-red-500 text-white py-1 px-3 rounded-md hover:bg-red-600 text-sm hidden">
                                Stop Test
                            </button>
                        </div>
                    </div>
                    
                    <!-- Add Output Navigation -->
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex space-x-2">
                            <button id="prevOutputBtn" onclick="showPreviousOutput()" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-md hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                Previous
                            </button>
                            <button id="nextOutputBtn" onclick="showNextOutput()" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-md hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
                            <span id="outputCounter" class="text-sm text-gray-600">0/0</span>
                        </div>
                    </div>

                    <pre id="outputText" class="bg-gray-50 p-4 rounded-md text-sm overflow-auto max-h-96 font-mono"></pre>

                    <!-- Add Results Table -->
                    <div class="mt-6">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Run</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Response Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Message</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTable" class="bg-white divide-y divide-gray-200">
                                <!-- Results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let performanceData = [];
        let isTestRunning = false;
        let responseTimeChart = null;
        let statusChart = null;
        let currentTest = null;
        let startTime;
        let cachedOutputs = [];
        let currentOutputIndex = -1;

        // Initialize charts
        function initializeCharts() {
            if (responseTimeChart) responseTimeChart.destroy();
            if (statusChart) statusChart.destroy();

            responseTimeChart = new Chart(document.getElementById('responseTimeChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Response Time (ms)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' ms';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Response Time Trend',
                            font: {
                                size: 16,
                                weight: 'normal'
                            },
                            padding: {
                                bottom: 20
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            statusChart = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Success', 'Failed'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                                },
                                padding: 15
                            }
                        },
                        title: {
                            display: true,
                            text: 'Success Rate',
                            font: {
                                size: 14,
                                weight: 'normal'
                            },
                            padding: {
                                bottom: 10
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        function updateCharts() {
            // Update response time chart
            responseTimeChart.data.labels = performanceData.map((_, i) => `Run ${i + 1}`);
            responseTimeChart.data.datasets[0].data = performanceData.map(d => d.responseTime);
            responseTimeChart.update('active'); // Force immediate update

            // Update status chart
            const successes = performanceData.filter(d => d.success).length;
            const failures = performanceData.length - successes;
            statusChart.data.datasets[0].data = [successes, failures];
            statusChart.update('active'); // Force immediate update
        }

        function updateStatistics() {
            if (performanceData.length === 0) {
                document.getElementById('avgResponseTime').textContent = '-';
                document.getElementById('minResponseTime').textContent = '-';
                document.getElementById('maxResponseTime').textContent = '-';
                document.getElementById('successRate').textContent = '-';
                return;
            }

            const responseTimes = performanceData.map(d => d.responseTime);
            const avg = responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length;
            const min = Math.min(...responseTimes);
            const max = Math.max(...responseTimes);
            const successRate = (performanceData.filter(d => d.success).length / performanceData.length) * 100;

            // Force immediate DOM updates
            requestAnimationFrame(() => {
            document.getElementById('avgResponseTime').textContent = `${avg.toFixed(2)} ms`;
            document.getElementById('minResponseTime').textContent = `${min.toFixed(2)} ms`;
            document.getElementById('maxResponseTime').textContent = `${max.toFixed(2)} ms`;
            document.getElementById('successRate').textContent = `${successRate.toFixed(1)}%`;
            });
        }

        function updateResultsTable() {
            const tbody = document.getElementById('resultsTable');
            requestAnimationFrame(() => {
            tbody.innerHTML = performanceData.map((data, index) => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${data.responseTime.toFixed(2)} ms</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${data.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${data.success ? 'Success' : 'Failed'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${data.success ? data.message : `${data.message}${data.error ? ` - ${data.error}` : ''}`}
                    </td>
                </tr>
            `).join('');
            });
        }

        function clearResults() {
            performanceData = [];
            cachedOutputs = [];
            currentOutputIndex = -1;
            
            // Update charts
            updateCharts();
            updateStatistics();
            
            // Clear the output text
            const outputText = document.getElementById('outputText');
            if (outputText) {
                outputText.textContent = '';
            }
            
            // Clear the results table
            const resultsTable = document.getElementById('resultsTable');
            if (resultsTable) {
                resultsTable.innerHTML = '';
            }
            
            // Update navigation
            updateOutputNavigation();
            
            // Reset command preview
            const commandPreview = document.getElementById('commandPreview');
            if (commandPreview) {
                commandPreview.textContent = 'moo command';
                commandPreview.classList.remove('text-gray-900');
                commandPreview.classList.add('text-gray-400');
            }
        }

        function stopTest() {
            isTestRunning = false;
            document.getElementById('stopButton').classList.add('hidden');
            
            // Reset all performance test buttons
            document.querySelectorAll('button[onclick*="runPerformanceTest"]').forEach(btn => {
                updatePerformanceTestButton(btn, false);
            });
        }

        // Add this helper function to update the performance test button state
        function updatePerformanceTestButton(button, isRunning, currentIteration = null, totalIterations = null) {
            if (isRunning) {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
                if (currentIteration !== null && totalIterations !== null) {
                    button.textContent = `Running Test ${currentIteration}/${totalIterations}...`;
                } else {
                    button.textContent = 'Running Test...';
                }
            } else {
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
                button.textContent = 'Run Performance Test';
            }
        }

        // Update the runPerformanceTest function
        async function runPerformanceTest(commandFunction) {
            const iterations = parseInt(document.getElementById('iterations').value);
            const delay = parseInt(document.getElementById('delay').value);
            
            // Get the specific performance test button that was clicked
            const perfTestBtn = document.activeElement;
            if (!perfTestBtn || !perfTestBtn.textContent.includes('Run Performance Test')) {  // Fixed the condition
                console.error('Could not identify performance test button');
                return;
            }

            isTestRunning = true;
            document.getElementById('stopButton').classList.remove('hidden');
            
            // Clear previous results
            clearResults();
            performanceData = [];
            cachedOutputs = [];
            currentOutputIndex = -1;
            
            // Initial button state
            updatePerformanceTestButton(perfTestBtn, true, 0, iterations);
            
            try {
                for (let i = 0; i < iterations && isTestRunning; i++) {
                    // Update button text before each iteration
                    updatePerformanceTestButton(perfTestBtn, true, i + 1, iterations);
                    
                    try {
                        console.log(`Starting iteration ${i + 1}/${iterations}`);
                        const result = await commandFunction(true);  // Pass true to indicate performance test
                        console.log(`Completed iteration ${i + 1}/${iterations}`, result);
                        
                        // Add to performance data with complete timing information
                        performanceData.push({
                            responseTime: result.timing ? result.timing.total_time * 1000 : result.responseTime,
                            success: result.success,
                            message: result.message,
                            error: result.error,
                            output: result.output,
                            command: result.command,
                            serverTime: result.timing ? result.timing.total_time * 1000 : null,
                            commandTime: result.timing ? result.timing.command_time * 1000 : null,
                            networkTime: result.clientTiming ? result.clientTiming.networkTime : null,
                            clientTime: result.clientTiming ? result.clientTiming.totalTime : null
                        });
                        
                        // Cache the output with complete timing information
                        cachedOutputs.push({
                            ...result,
                            iterationNumber: i + 1,
                            timing: result.timing,
                            clientTiming: result.clientTiming,
                            responseTime: result.timing ? result.timing.total_time * 1000 : result.responseTime
                        });
                        
                        currentOutputIndex = cachedOutputs.length - 1;
                        
                        // Force immediate UI updates
                        await new Promise(resolve => {
                            requestAnimationFrame(() => {
                                try {
                                    displayCachedOutput(currentOutputIndex);
                                    updateCharts();
                                    updateStatistics();
                                    updateResultsTable();
                                    updateOutputNavigation();
                                    resolve();
                                } catch (updateError) {
                                    console.error('Error updating UI:', updateError);
                                    resolve();
                                }
                            });
                        });
                        
                    } catch (iterationError) {
                        console.error(`Error in iteration ${i + 1}:`, iterationError);
                        
                        const errorResult = {
                            success: false,
                            message: 'Test failed',
                            error: iterationError.message,
                            responseTime: 0,
                            command: document.getElementById('commandPreview').textContent,
                            iterationNumber: i + 1,
                            timing: null,
                            clientTiming: null
                        };
                        
                        performanceData.push({
                            responseTime: 0,
                            success: false,
                            message: 'Test failed',
                            error: iterationError.message,
                            command: errorResult.command
                        });
                        
                        cachedOutputs.push(errorResult);
                        currentOutputIndex = cachedOutputs.length - 1;
                        
                        // Update UI even for errors
                        await new Promise(resolve => {
                            requestAnimationFrame(() => {
                                try {
                                    displayCachedOutput(currentOutputIndex);
                                    updateCharts();
                                    updateStatistics();
                                    updateResultsTable();
                                    updateOutputNavigation();
                                    resolve();
                                } catch (updateError) {
                                    console.error('Error updating UI:', updateError);
                                    resolve();
                                }
                            });
                        });
                    }
                    
                    // Wait for delay between iterations
                    if (i < iterations - 1 && isTestRunning) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            } catch (error) {
                console.error('Performance test failed:', error);
            } finally {
                // Reset test state
                isTestRunning = false;
                document.getElementById('stopButton').classList.add('hidden');
                updatePerformanceTestButton(perfTestBtn, false);
                
                // Final UI update
                await new Promise(resolve => {
                    requestAnimationFrame(() => {
                        try {
                            updateCharts();
                            updateStatistics();
                            updateResultsTable();
                            updateOutputNavigation();
                            resolve();
                        } catch (error) {
                            console.error('Error in final UI update:', error);
                            resolve();
                        }
                    });
                });
            }
        }

        function updateOutputNavigation() {
            const prevBtn = document.getElementById('prevOutputBtn');
            const nextBtn = document.getElementById('nextOutputBtn');
            const counter = document.getElementById('outputCounter');
            
            if (prevBtn) prevBtn.disabled = currentOutputIndex <= 0;
            if (nextBtn) nextBtn.disabled = currentOutputIndex >= cachedOutputs.length - 1;
            if (counter) {
                counter.textContent = cachedOutputs.length > 0 ? `${currentOutputIndex + 1}/${cachedOutputs.length}` : '0/0';
            }
        }

        function showPreviousOutput() {
            if (currentOutputIndex > 0) {
                currentOutputIndex--;
                displayCachedOutput(currentOutputIndex);
            }
        }

        function showNextOutput() {
            if (currentOutputIndex < cachedOutputs.length - 1) {
                currentOutputIndex++;
                displayCachedOutput(currentOutputIndex);
            }
        }

        function displayCachedOutput(index) {
            const output = cachedOutputs[index];
            const outputElement = document.getElementById('outputText');
            
            // Update command preview
            const commandPreview = document.getElementById('commandPreview');
            if (output.command) {
                commandPreview.textContent = output.command;
                commandPreview.classList.remove('text-gray-400');
                commandPreview.classList.add('text-gray-900');
            }
            
            // Build detailed output text with timing information
            const timingDetails = output.timing ? `
Timing Details:
- Total Time: ${(output.timing.total_time * 1000).toFixed(2)} ms
- Command Execution: ${(output.timing.command_time * 1000).toFixed(2)} ms
- Server Processing: ${(output.timing.server_processing_time * 1000).toFixed(2)} ms
- Client Network Time: ${output.clientTiming ? output.clientTiming.networkTime.toFixed(2) + ' ms' : 'N/A'}
- Total Client Time: ${output.clientTiming ? output.clientTiming.totalTime.toFixed(2) + ' ms' : 'N/A'}` : '';

            const outputText = [
                `Test Run ${output.iterationNumber}`,
                `Command: ${output.command || 'Unknown command'}`,
                `Status: ${output.success ? 'Success' : 'Failed'}`,
                `Response Time: ${output.responseTime.toFixed(2)} ms`,
                `Message: ${output.message}`,
                timingDetails
            ];

            if (output.output) {
                outputText.push('\nOutput:', output.output);
            }
            if (output.error) {
                outputText.push('\nError:', output.error);
            }
            
            outputElement.textContent = outputText.join('\n');
            outputElement.className = output.success ? 
                'bg-green-50 p-4 rounded-md text-sm overflow-auto max-h-96 font-mono' : 
                'bg-red-50 p-4 rounded-md text-sm overflow-auto max-h-96 font-mono';
            
            updateOutputNavigation();
        }

        function updateOutput(data) {
            const outputElement = document.getElementById('outputText');
            const timingDetails = data.timing ? `
Timing Details:
- Total Time: ${(data.timing.total_time * 1000).toFixed(2)} ms
- Command Execution: ${(data.timing.command_time * 1000).toFixed(2)} ms
- Server Processing: ${(data.timing.server_processing_time * 1000).toFixed(2)} ms
- Client Network Time: ${data.clientTiming ? data.clientTiming.networkTime.toFixed(2) + ' ms' : 'N/A'}
- Total Client Time: ${data.clientTiming ? data.clientTiming.totalTime.toFixed(2) + ' ms' : 'N/A'}` : '';

            const output = `Status: ${data.success ? 'Success' : 'Failed'}
Message: ${data.message}
${timingDetails}
${data.output ? '\nOutput:\n' + data.output : ''}${data.error ? '\nError:\n' + data.error : ''}`;
            
            // Use requestAnimationFrame for smoother updates
            requestAnimationFrame(() => {
                outputElement.textContent = output;
                outputElement.className = data.success ? 
                    'bg-green-50 p-4 rounded-md text-sm overflow-auto max-h-96 font-mono' : 
                    'bg-red-50 p-4 rounded-md text-sm overflow-auto max-h-96 font-mono';
            });
        }

        // Add this function for MOO login
        async function mooLogin() {
            const username = document.getElementById('mooUsername').value;
            const password = document.getElementById('mooPassword').value;
            
            // Get all the checkbox values
            const deviceCode = document.getElementById('deviceCode').checked;
            const interactive = document.getElementById('interactive').checked;
            const managedIdentity = document.getElementById('managedIdentity').checked;
            const servicePrincipal = document.getElementById('servicePrincipal').checked;
            const refresh = document.getElementById('refresh').checked;
            
            try {
                const response = await fetch('/api/moo-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        device_code: deviceCode,
                        interactive,
                        managed_identity: managedIdentity,
                        service_principal: servicePrincipal,
                        refresh
                    })
                });
                
                const data = await response.json();
                updateOutput(data);
                
            } catch (error) {
                updateOutput({
                    success: false,
                    message: 'Error: ' + error.message,
                    error: error.toString()
                });
            }
        }

        async function mooLogout() {
            const useSudo = document.getElementById('useSudo').checked;
            try {
                const response = await fetch('/api/moo-logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        use_sudo: useSudo
                    }),
                });
                
                const data = await response.json();
                updateOutput(data);
            } catch (error) {
                updateOutput({ success: false, message: 'Error: ' + error.message });
            }
        }

        function updateCommandPreview(args) {
            const commandPreview = document.getElementById('commandPreview');
            const useSudo = document.getElementById('useSudo').checked;
            
            // If args is an array, join it; if it's a string, use it as is
            const fullCommand = Array.isArray(args) ? args.join(' ') : args;
            
            // Add sudo if needed, but don't add 'moo' since it should already be in args
            commandPreview.textContent = useSudo ? `sudo ${fullCommand}` : fullCommand;
            commandPreview.classList.remove('text-gray-400');
            commandPreview.classList.add('text-gray-900');
            return fullCommand;
        }

        async function executeLsCommand(isPerformanceTest = false) {
            const uri = document.getElementById('mooseUri').value;
            const args = ['moo', 'ls'];  // Start with 'moo ls'
            const useSudo = document.getElementById('useSudo').checked;
            
            // Add URI after the command
            if (uri) args.push(uri);
            
            // Collect all options
            const options = {
                'lsAccessTime': '-u',
                'lsAll': '-a',
                'lsDirectory': '-d',
                'lsFull': '-f',
                'lsMedia': '-m',
                'lsRecursive': '-r',
                'lsRegex': '--regex',
                'lsSize': '-S',
                'lsTime': '-t',
                'lsViewMetadata': '-v',
                'lsXml': '-x'
            };

            // Add enabled options
            Object.entries(options).forEach(([id, flag]) => {
                if (document.getElementById(id).checked) args.push(flag);
            });
            
            const page = document.getElementById('lsPage').value;
            if (page) args.push(`--page=${page}`);

            // Update command preview
            const commandPreview = document.getElementById('commandPreview');
            const fullCommand = args.join(' ');  // Don't add 'moo' again since it's already in args
            commandPreview.textContent = useSudo ? `sudo ${fullCommand}` : fullCommand;
            commandPreview.classList.remove('text-gray-400');
            commandPreview.classList.add('text-gray-900');
            
            if (!isPerformanceTest) {
                const btn = document.getElementById('lsCommandBtn');
                const loadingSpinner = document.getElementById('lsCommandLoading');
                btn.disabled = true;
                btn.querySelector('span:not(#lsCommandLoading)').classList.add('opacity-0');
                loadingSpinner.classList.remove('hidden');
            }
            
            startTime = performance.now();
            
            try {
                const response = await fetch('/api/execute-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        args,  // Send the complete args array including 'moo ls'
                        use_sudo: useSudo
                    }),
                });
                
                const data = await response.json();
                if (!isPerformanceTest) {
                    updateOutput(data);
                    const btn = document.getElementById('lsCommandBtn');
                    const loadingSpinner = document.getElementById('lsCommandLoading');
                    btn.disabled = false;
                    btn.querySelector('span:not(#lsCommandLoading)').classList.remove('opacity-0');
                    loadingSpinner.classList.add('hidden');
                }
                return data;
            } catch (error) {
                const errorData = {
                    success: false,
                    message: 'Error: ' + error.message,
                    responseTime: performance.now() - startTime
                };
                if (!isPerformanceTest) {
                    updateOutput(errorData);
                }
                return errorData;
            }
        }

        async function executeSiCommand(isPerformanceTest = false) {
            const args = ['moo', 'si'];  // Changed from ['si'] to ['moo', 'si']
            const useSudo = document.getElementById('useSudo').checked;
            
            // Add options
            if (document.getElementById('siLong').checked) args.push('--long');
            if (document.getElementById('siXml').checked) args.push('--xml');

            // Update command preview with sudo if needed
            const commandPreview = document.getElementById('commandPreview');
            const fullCommand = useSudo ? `sudo moo ${args.join(' ')}` : `moo ${args.join(' ')}`;
            commandPreview.textContent = fullCommand;
            commandPreview.classList.remove('text-gray-400');
            commandPreview.classList.add('text-gray-900');
            
            if (!isPerformanceTest) {
                const btn = document.getElementById('siCommandBtn');
                const loadingSpinner = document.getElementById('siCommandLoading');
                btn.disabled = true;
                btn.querySelector('span:not(#siCommandLoading)').classList.add('opacity-0');
                loadingSpinner.classList.remove('hidden');
            }
            
            const startTime = performance.now();
            
            try {
                const response = await fetch('/api/execute-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        args,
                        use_sudo: useSudo
                    }),
                });
                
                const data = await response.json();
                if (!isPerformanceTest) {
                    updateOutput(data);
                    const btn = document.getElementById('siCommandBtn');
                    const loadingSpinner = document.getElementById('siCommandLoading');
                    btn.disabled = false;
                    btn.querySelector('span:not(#siCommandLoading)').classList.remove('opacity-0');
                    loadingSpinner.classList.add('hidden');
                }
                return data;
            } catch (error) {
                const errorData = {
                    success: false,
                    message: 'Error: ' + error.message,
                    responseTime: performance.now() - startTime
                };
                if (!isPerformanceTest) {
                    updateOutput(errorData);
                    const btn = document.getElementById('siCommandBtn');
                    const loadingSpinner = document.getElementById('siCommandLoading');
                    btn.disabled = false;
                    btn.querySelector('span:not(#siCommandLoading)').classList.remove('opacity-0');
                    loadingSpinner.classList.add('hidden');
                }
                return errorData;
            }
        }

        // Add this function to handle button states
        function updateGetCommandButtons(isRunning) {
            const executeBtn = document.getElementById('getCommandBtn');
            const loadingSpinner = document.getElementById('getCommandLoading');
            const perfTestBtn = document.querySelector('button[onclick="runPerformanceTest(executeGetCommand)"]');
            
            if (isRunning) {
                // Disable and show loading state for execute button
                executeBtn.disabled = true;
                executeBtn.querySelector('span:not(#getCommandLoading)').classList.add('opacity-0');
                loadingSpinner.classList.remove('hidden');
                
                // Disable and update performance test button
                perfTestBtn.disabled = true;
                perfTestBtn.classList.add('opacity-50', 'cursor-not-allowed');
                perfTestBtn.textContent = 'Command Running...';
            } else {
                // Reset execute button
                executeBtn.disabled = false;
                executeBtn.querySelector('span:not(#getCommandLoading)').classList.remove('opacity-0');
                loadingSpinner.classList.add('hidden');
                
                // Reset performance test button
                perfTestBtn.disabled = false;
                perfTestBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                perfTestBtn.textContent = 'Run Performance Test';
            }
        }

        // Update the executeGetCommand function
        async function executeGetCommand(isPerformanceTest = false) {
            const uri = document.getElementById('getMooseUri').value;
            const destPath = document.getElementById('getDestPath').value;
            const args = ['moo', 'get'];  // Changed from ['get'] to ['moo', 'get']
            const useSudo = document.getElementById('useSudo').checked;
            
            if (!uri || !destPath) {
                const errorData = { 
                    success: false, 
                    message: 'Error: Both MOOSE URI and Destination Path are required',
                    responseTime: 0,
                    command: 'moo get'
                };
                if (!isPerformanceTest) {
                    updateOutput(errorData);
                }
                return errorData;
            }

            args.push(uri);
            args.push(destPath);
            
            // Add options efficiently
            const options = {
                'getForce': '--force',
                'getCompressed': '--compressed-transfer',
                'getFillGaps': '--fill-gaps',
                'getFillGapsOverwrite': '--fill-gaps-and-overwrite-smaller-files',
                'getIfAvailable': '--get-if-available',
                'getLargeRetrieval': '--large-retrieval',
                'getRegex': '--regex'
            };

            Object.entries(options).forEach(([id, flag]) => {
                if (document.getElementById(id)?.checked) args.push(flag);
            });
            
            const licenseFile = document.getElementById('getLicenseFile')?.value;
            if (licenseFile) args.push(`--licence-file=${licenseFile}`);

            // Update command preview with sudo if needed
            const commandPreview = document.getElementById('commandPreview');
            const fullCommand = useSudo ? `sudo moo ${args.join(' ')}` : `moo ${args.join(' ')}`;
            commandPreview.textContent = fullCommand;
            commandPreview.classList.remove('text-gray-400');
            commandPreview.classList.add('text-gray-900');

            if (!isPerformanceTest) {
                updateGetCommandButtons(true);
            }
            
            const clientTiming = {
                startTime: performance.now(),
                fetchStartTime: null,
                fetchEndTime: null,
                endTime: null,
            };
            
            try {
                clientTiming.fetchStartTime = performance.now();
                const response = await fetch('/api/execute-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        args,
                        use_sudo: useSudo
                    }),
                });
                
                clientTiming.fetchEndTime = performance.now();
                const data = await response.json();
                clientTiming.endTime = performance.now();
                
                data.timing = {
                    ...data.timing,
                    client: {
                        total: clientTiming.endTime - clientTiming.startTime,
                        fetch: clientTiming.fetchEndTime - clientTiming.fetchStartTime,
                        parse: clientTiming.endTime - clientTiming.fetchEndTime
                    }
                };
                
                if (!isPerformanceTest) {
                    updateOutput(data);
                    updateGetCommandButtons(false);
                }
                return data;
            } catch (error) {
                const errorData = {
                    success: false,
                    message: 'Error: ' + error.message,
                    timing: {
                        client: {
                            total: performance.now() - clientTiming.startTime
                        }
                    }
                };
                if (!isPerformanceTest) {
                    updateOutput(errorData);
                    updateGetCommandButtons(false);
                }
                return errorData;
            }
        }

        async function executePutCommand(isPerformanceTest = false) {
            const sourcePath = document.getElementById('putSourcePath').value;
            const destUri = document.getElementById('putDestUri').value;
            const args = ['moo', 'put'];  // Changed from ['put'] to ['moo', 'put']
            const useSudo = document.getElementById('useSudo').checked;
            
            if (!sourcePath || !destUri) {
                const errorData = { 
                    success: false, 
                    message: 'Error: Both Source Path and Destination URI are required',
                    responseTime: 0,
                    command: 'moo put'
                };
                if (!isPerformanceTest) {
                    updateOutput(errorData);
                }
                return errorData;
            }

            args.push(sourcePath);
            args.push(destUri);
            
            // Add options with proper null checks
            const checkboxOptions = {
                'putCompressed': '--compressed-transfer',
                'putForce': '--force',
                'putForceExcludingIdentical': '--force-excluding-identical',
                'putDryRun': '--dry-run',
                'putQuiet': '--quiet',
                'putVerbose': '--verbose'
            };

            Object.entries(checkboxOptions).forEach(([id, flag]) => {
                const element = document.getElementById(id);
                if (element && element.checked) {
                    args.push(flag);
                }
            });
            
            // Handle optional inputs with null checks
            const transferThreads = document.getElementById('putTransferThreads');
            if (transferThreads && transferThreads.value) {
                args.push(`--transfer-threads=${transferThreads.value}`);
            }

            const actAs = document.getElementById('putActAs');
            if (actAs && actAs.value) {
                args.push(`--act-as=${actAs.value}`);
            }

            // Update command preview with sudo if needed
            const commandPreview = document.getElementById('commandPreview');
            const fullCommand = useSudo ? `sudo moo ${args.join(' ')}` : `moo ${args.join(' ')}`;
            commandPreview.textContent = fullCommand;
            commandPreview.classList.remove('text-gray-400');
            commandPreview.classList.add('text-gray-900');
            
            let btn, loadingSpinner;
            if (!isPerformanceTest) {
                btn = document.getElementById('putCommandBtn');
                loadingSpinner = document.getElementById('putCommandLoading');
                if (btn && loadingSpinner) {
                    btn.disabled = true;
                    const span = btn.querySelector('span:not(#putCommandLoading)');
                    if (span) span.classList.add('opacity-0');
                    loadingSpinner.classList.remove('hidden');
                }
            }
            
            const startTime = performance.now();
            
            try {
                const response = await fetch('/api/execute-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        args,
                        use_sudo: useSudo
                    }),
                });
                
                const data = await response.json();
                if (!isPerformanceTest) {
                    updateOutput(data);
                }
                return data;
            } catch (error) {
                const errorData = {
                    success: false,
                    message: 'Error: ' + error.message,
                    responseTime: performance.now() - startTime
                };
                if (!isPerformanceTest) {
                    updateOutput(errorData);
                }
                return errorData;
            } finally {
                if (!isPerformanceTest && btn && loadingSpinner) {
                    btn.disabled = false;
                    const span = btn.querySelector('span:not(#putCommandLoading)');
                    if (span) span.classList.remove('opacity-0');
                    loadingSpinner.classList.add('hidden');
                }
            }
        }

        async function adminLogout() {
            try {
                const response = await fetch('/admin/logout', {
                    method: 'POST',
                });
                
                const data = await response.json();
                if (data.success) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        function displayResults(data) {
            const commandDetails = document.getElementById('commandDetails');
            const commandTimeline = document.getElementById('commandTimeline');
            
            // Display command details
            if (data.commandDetails) {
                commandDetails.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium mb-2">Command Details</h4>
                        <pre class="text-sm whitespace-pre-wrap">${JSON.stringify(data.commandDetails, null, 2)}</pre>
                    </div>
                `;
            } else {
                commandDetails.innerHTML = '<p class="text-gray-500">No command details available</p>';
            }
            
            // Display timeline
            if (data.timeline && data.timeline.length > 0) {
                commandTimeline.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium mb-2">Command Timeline</h4>
                        <div class="space-y-2">
                            ${data.timeline.map(event => `
                                <div class="border-l-2 border-blue-500 pl-4 py-2">
                                    <div class="text-sm text-gray-600">${new Date(event.timestamp).toLocaleString()}</div>
                                    <div class="text-sm">${event.message}</div>
                                    ${event.details ? `<pre class="text-xs text-gray-500 mt-1">${JSON.stringify(event.details, null, 2)}</pre>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                commandTimeline.innerHTML = '<p class="text-gray-500">No timeline events available</p>';
            }
        }

        async function searchAppInsights() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const appId = document.getElementById('appId').value.trim();
            const commandId = document.getElementById('commandId').value.trim();
            const timeRange = document.getElementById('timeRange').value;
            const searchTraces = document.getElementById('searchTraces').checked;
            const searchRequests = document.getElementById('searchRequests').checked;
            const searchDependencies = document.getElementById('searchDependencies').checked;

            const outputText = document.getElementById('outputText');
            
            // Debug log the actual values
            console.log('Form Values:', {
                apiKeyPresent: !!apiKey,
                apiKeyLength: apiKey.length,
                appId,
                appIdLength: appId.length,
                commandId,
                commandIdLength: commandId.length,
                timeRange,
                searchTypes: {
                    traces: searchTraces,
                    requests: searchRequests,
                    dependencies: searchDependencies
                }
            });
            
            // Detailed validation
            const missing = [];
            if (!apiKey) missing.push('API Key');
            if (!appId) missing.push('Application ID');
            if (!commandId) missing.push('Command ID');

            if (missing.length > 0) {
                const errorMessage = `Missing required fields: ${missing.join(', ')}`;
                console.error('Validation error:', {
                    apiKeyLength: apiKey.length,
                    appIdLength: appId.length,
                    commandIdLength: commandId.length,
                    missing
                });
                outputText.textContent = errorMessage;
                outputText.className = 'bg-red-50 p-4 rounded-md text-sm overflow-auto max-h-96';
                alert(errorMessage);
                return;
            }

            if (!searchTraces && !searchRequests && !searchDependencies) {
                const errorMessage = 'Please select at least one type of data to search in';
                outputText.textContent = errorMessage;
                outputText.className = 'bg-red-50 p-4 rounded-md text-sm overflow-auto max-h-96';
                alert(errorMessage);
                return;
            }

            const searchButton = document.getElementById('searchButton');
            const searchSpinner = document.getElementById('searchSpinner');
            const searchResults = document.getElementById('searchResults');

            searchButton.disabled = true;
            searchSpinner.classList.remove('hidden');
            searchResults.classList.add('hidden');

            try {
                // Simplified request body with exact parameter names
                const requestBody = {
                    apiKey: apiKey,
                    appId: appId,
                    commandId: commandId,
                    timeRange: timeRange,
                    searchTypes: {
                        traces: searchTraces,
                        requests: searchRequests,
                        dependencies: searchDependencies
                    }
                };

                // Debug log the request body (without sensitive info)
                console.log('Request Body (sanitized):', {
                    ...requestBody,
                    apiKey: '***'
                });

                const response = await fetch('/api/search-appinsights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                let data;
                const responseText = await response.text();
                console.log('Raw API Response:', responseText);

                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse response as JSON:', parseError);
                    throw new Error('Invalid response format from server');
                }

                console.log('API Response:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    data: data
                });

                if (data.success) {
                    displayResults(data);
                    searchResults.classList.remove('hidden');
                    outputText.textContent = 'Search completed successfully';
                    outputText.className = 'bg-green-50 p-4 rounded-md text-sm overflow-auto max-h-96';
                } else {
                    let errorDetails = '';
                    if (data.details) {
                        errorDetails = `\nDetails: ${JSON.stringify(data.details, null, 2)}`;
                    }
                    
                    const errorMessage = `Error searching App Insights:\n${data.message || 'Unknown error'}${errorDetails}\n\nRequest Details:\nCommand ID: ${commandId}\nApp ID: ${appId}\nTime Range: ${timeRange}\nSearch Types: ${Object.entries(requestBody.searchTypes).filter(([,v]) => v).map(([k]) => k).join(', ')}`;
                    
                    outputText.textContent = errorMessage;
                    outputText.className = 'bg-red-50 p-4 rounded-md text-sm overflow-auto max-h-96';
                    console.error('Search failed:', {
                        error: data.message,
                        requestBody: requestBody,
                        response: data
                    });
                }
            } catch (error) {
                console.error('Search error:', error);
                const errorMessage = `Error searching App Insights:\n${error.message}\n\nRequest Details:\nCommand ID: ${commandId}\nApp ID: ${appId}\nTime Range: ${timeRange}`;
                outputText.textContent = errorMessage;
                outputText.className = 'bg-red-50 p-4 rounded-md text-sm overflow-auto max-h-96';
                alert('Error searching App Insights: ' + error.message);
            } finally {
                searchButton.disabled = false;
                searchSpinner.classList.add('hidden');
            }
        }

        // Update the showSection function to handle the new active state
        function showSection(section) {
            console.log('showSection called with:', section);
            
            // First, hide all sections
            const sections = document.querySelectorAll('[id$="-section"]');
            sections.forEach(el => {
                el.style.display = 'none';
            });

            // Show the selected section
            const selectedSection = document.getElementById(`${section}-section`);
            if (selectedSection) {
                selectedSection.style.display = 'block';
            } else {
                console.error('Section not found:', section);
            }

            // Update the title
            const titles = {
                'login': 'MOO Login/Logout',
                'ls': 'MOO LS Command',
                'get': 'MOO GET Command',
                'si': 'MOO System Information',
                'put': 'MOO PUT Command',
                'projinfo': 'MOO Projinfo Command',
                'appinsights': 'App Insights Search'
            };
            
            const titleElement = document.getElementById('section-title');
            if (titleElement) {
                titleElement.textContent = titles[section] || 'MOO CLI Performance Tester';
            }

            // Update button highlighting - remove active class from all buttons
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('bg-gray-200');
            });
            
            // Add active class to selected button
            const activeNav = document.getElementById(`nav-${section}`);
            if (activeNav) {
                activeNav.classList.add('bg-gray-200');
            }
        }

        // Remove the event listeners from DOMContentLoaded and use onclick attributes
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Initialize charts
            initializeCharts();
            
            // Show initial section
            showSection('login');
            
            // Initialize file type handling
            handleFileTypeChange();
            
            // Remove any existing click handlers from nav buttons
            const navButtons = document.querySelectorAll('nav button');
            navButtons.forEach(button => {
                button.removeEventListener('click', () => {});
            });
        });

        // Add this new function to handle MOOSE URI updates
        function updateMooseUri() {
            const fileType = document.getElementById('fileType').value;
            const fileSize = document.getElementById('fileSize').value;
            const sizeType = fileType === 'nc' || fileType.startsWith('pp-') || fileType.startsWith('tar-') ? 'approx' : document.querySelector('input[name="sizeType"]:checked').value;
            
            if (!fileSize) {
                return; // Don't update if no size is selected
            }
            
            // Construct the MOOSE URI based on file type
            let uri;
            if (fileType === 'nc') {
                uri = `moose:/test/core/files/files.nc.file/nc-${fileSize}-approx.nc`;
            } else if (fileType === 'file') {
                uri = `moose:/test/core/files/files.file/file-${fileSize}-${sizeType}.file`;
            } else if (fileType.startsWith('pp-')) {
                const compression = fileType.split('-')[1]; // high, medium, or low
                uri = `moose:/test/core/files/files.pp/pp-${compression}-${fileSize}-approx.pp`;
            } else if (fileType.startsWith('tar-')) {
                const compression = fileType.split('-')[1]; // high, medium, or low
                uri = `moose:/test/core/files/files.tar/tar-${compression}-${fileSize}-approx.tar`;
            } else {
                uri = `moose:/test/core/files/files.${fileType}/file-${fileSize}-${sizeType}.${fileType}`;
            }
            
            // Update the MOOSE URI input field
            document.getElementById('getMooseUri').value = uri;
            
            // Update the command preview
            updateCommandPreview(['get', uri, document.getElementById('getDestPath').value]);
        }

        // Add these file size mappings
        const availableSizes = {
            'nc': ['1-mib', '2-mib', '4-mib', '10-mib', '100-mib', '1-gib', '2-gib', '5-gib', '10-gib', '20-gib'],
            'file': ['1-kib', '10-kib', '100-kib', '1-mib', '2-mib', '4-mib', '10-mib', '100-mib', 
                    '1-gib', '2-gib', '5-gib', '10-gib', '20-gib', '50-gib', '100-gib', '1-tib'],
            'pp-high': ['1-mib', '2-mib', '4-mib', '10-mib', '100-mib', '1-gib', '2-gib', '10-gib', '100-gib', '1-tib'],
            'pp-medium': ['1-mib', '2-mib', '4-mib', '10-mib', '100-mib', '1-gib', '2-gib', '10-gib', '100-gib', '1-tib'],
            'pp-low': ['10-mib', '100-mib', '1-gib', '2-gib', '5-gib', '10-gib', '20-gib', '50-gib', '100-gib', '1-tib'],
            'tar-high': ['1-mib', '2-mib', '4-mib', '10-mib', '100-mib', '1-gib', '2-gib', '10-gib', '100-gib', '1-tib'],
            'tar-medium': ['1-mib', '2-mib', '4-mib', '10-mib', '100-mib', '1-gib', '2-gib', '10-gib', '100-gib', '1-tib'],
            'tar-low': ['10-mib', '100-mib', '1-gib', '2-gib', '5-gib', '10-gib', '20-gib', '50-gib', '100-gib', '1-tib']
        };

        // Function to update file size options based on file type
        function updateFileSizeOptions() {
            const fileType = document.getElementById('fileType').value;
            const fileSizeSelect = document.getElementById('fileSize');
            const sizes = availableSizes[fileType] || [];
            
            // Save current selection if possible
            const currentSelection = fileSizeSelect.value;
            
            // Clear current options
            fileSizeSelect.innerHTML = '<option value="">Select a size...</option>';
            
            // Add size options
            sizes.forEach(size => {
                const [value, unit] = size.split('-');
                const label = `${value} ${unit.toUpperCase()}`;
                const option = document.createElement('option');
                option.value = size;
                option.textContent = label;
                fileSizeSelect.appendChild(option);
            });
            
            // Restore selection if it's still valid
            if (sizes.includes(currentSelection)) {
                fileSizeSelect.value = currentSelection;
            }
            
            // Update URI with new selection
            updateMooseUri();
        }

        // Update the handleFileTypeChange function
        function handleFileTypeChange() {
            const fileType = document.getElementById('fileType').value;
            const exactRadio = document.querySelector('input[name="sizeType"][value="exact"]');
            const approxRadio = document.querySelector('input[name="sizeType"][value="approx"]');
            
            if (fileType === 'nc' || fileType.startsWith('pp-') || fileType.startsWith('tar-')) {
                // For NC, PP, and TAR files, force "approx" and disable "exact"
                exactRadio.disabled = true;
                approxRadio.checked = true;
                exactRadio.parentElement.classList.add('opacity-50');
            } else {
                // For other file types, enable both options
                exactRadio.disabled = false;
                exactRadio.parentElement.classList.remove('opacity-50');
            }
            
            // Update available file sizes
            updateFileSizeOptions();
        }

        // Add these new functions for tab handling
        function switchGetTab(tab) {
            // Update tab buttons
            document.getElementById('files-tab').classList.toggle('border-indigo-500', tab === 'files');
            document.getElementById('files-tab').classList.toggle('text-indigo-600', tab === 'files');
            document.getElementById('folders-tab').classList.toggle('border-indigo-500', tab === 'folders');
            document.getElementById('folders-tab').classList.toggle('text-indigo-600', tab === 'folders');
            
            // Update content visibility
            document.getElementById('files-content').classList.toggle('hidden', tab !== 'files');
            document.getElementById('folders-content').classList.toggle('hidden', tab !== 'folders');
        }

        function handleFileSelectionTypeChange() {
            const selectionType = document.getElementById('fileSelectionType').value;
            document.getElementById('size-based-selection').classList.toggle('hidden', selectionType !== 'size');
            document.getElementById('count-based-selection').classList.toggle('hidden', selectionType !== 'count');
            
            if (selectionType === 'count') {
                handleCountBasedChange();
            } else {
                updateMooseUri();
            }
        }

        function handleCountBasedChange() {
            const fileType = document.getElementById('countFileType').value;
            const fileCount = document.getElementById('fileCount').value;
            const paddedCount = fileCount.padStart(8, '0');
            
            let uri;
            if (fileType === 'nc') {
                uri = `moose:/test/core/magnitude-nc.file/dc-${paddedCount}.nc.file`;
            } else if (fileType === 'file') {
                uri = `moose:/test/core/magnitude-file/dc-${paddedCount}.file`;
            } else if (fileType === 'pp') {
                uri = `moose:/test/core/magnitude-pp/dc-${paddedCount}.pp`;
            }
            
            document.getElementById('getMooseUri').value = uri;
            updateCommandPreview(['get', uri, document.getElementById('getDestPath').value]);
        }

        // Add this new function for folder handling
        function handleFolderTypeChange() {
            const folderType = document.getElementById('folderType').value;
            const fileCount = document.getElementById('folderFileCount').value;
            const paddedCount = fileCount.padStart(8, '0');
            let uri;
            
            if (folderType === 'nc') {
                uri = `moose:/test/core/magnitude-nc.file/dc-${paddedCount}.nc.file`;
            } else if (folderType === 'file') {
                uri = `moose:/test/core/magnitude-file/dc-${paddedCount}.file`;
            } else if (folderType === 'pp') {
                uri = `moose:/test/core/magnitude-pp/dc-${paddedCount}.pp`;
            }
            
            document.getElementById('getMooseUri').value = uri;
            updateCommandPreview(['get', uri, document.getElementById('getDestPath').value]);
        }

        // Project Info Command Functions
        let projectNames = new Set();

        function addProjectName() {
            const input = document.getElementById('projinfoProjectNames');
            const names = input.value.trim().split(/\s+/);
            
            names.forEach(name => {
                if (name) {
                    projectNames.add(name);
                }
            });
            
            updateProjectNamesList();
            input.value = '';
            updateProjinfoCommandPreview();
        }

        function removeProjectName(name) {
            projectNames.delete(name);
            updateProjectNamesList();
            updateProjinfoCommandPreview();
        }

        function updateProjectNamesList() {
            const list = document.getElementById('projectNamesList');
            list.innerHTML = '';
            
            projectNames.forEach(name => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                div.innerHTML = `
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-md text-sm">${name}</span>
                    <button onclick="removeProjectName('${name}')" class="text-red-600 hover:text-red-800">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function updateProjinfoCommandPreview() {
            const cmd = ['moo', 'projinfo'];
            const useSudo = document.getElementById('useSudo').checked;
            
            // Add project names
            cmd.push(...Array.from(projectNames));
            
            // Add options
            if (document.getElementById('projinfoLong').checked) cmd.push('-l');
            if (document.getElementById('projinfoMembers').checked) cmd.push('-m');
            if (document.getElementById('projinfoXml').checked) cmd.push('-x');
            if (document.getElementById('projinfoDryRun').checked) cmd.push('-n');
            if (document.getElementById('projinfoQuiet').checked) cmd.push('-q');
            if (document.getElementById('projinfoVerbose').checked) cmd.push('-v');
            
            const actAs = document.getElementById('projinfoActAs').value.trim();
            if (actAs) cmd.push(`--act-as=${actAs}`);
            
            // Update preview
            const preview = document.getElementById('commandPreview');
            const fullCommand = useSudo ? `sudo ${cmd.join(' ')}` : cmd.join(' ');
            preview.textContent = fullCommand;
            preview.classList.remove('text-gray-400');
            preview.classList.add('text-gray-900');
        }

        async function executeProjinfoCommand(isPerformanceTest = false) {
            if (projectNames.size === 0) {
                if (!isPerformanceTest) {
                    alert('Please add at least one project name.');
                }
                return {
                    success: false,
                    message: 'No project names specified',
                    responseTime: 0
                };
            }
            
            const args = ['moo', 'projinfo'];  // Changed from ['projinfo'] to ['moo', 'projinfo']
            args.push(...Array.from(projectNames));
            
            // Add all options
            if (document.getElementById('projinfoLong').checked) args.push('-l');
            if (document.getElementById('projinfoMembers').checked) args.push('-m');
            if (document.getElementById('projinfoXml').checked) args.push('-x');
            if (document.getElementById('projinfoDryRun').checked) args.push('-n');
            if (document.getElementById('projinfoQuiet').checked) args.push('-q');
            if (document.getElementById('projinfoVerbose').checked) args.push('-v');
            
            const actAs = document.getElementById('projinfoActAs').value.trim();
            if (actAs) args.push(`--act-as=${actAs}`);
            
            const useSudo = document.getElementById('useSudo').checked;
            
            if (!isPerformanceTest) {
                const btn = document.getElementById('projinfoCommandBtn');
                const loadingSpinner = document.getElementById('projinfoCommandLoading');
                btn.disabled = true;
                btn.querySelector('span:not(#projinfoCommandLoading)').classList.add('opacity-0');
                loadingSpinner.classList.remove('hidden');
            }
            
            try {
                const response = await fetch('/api/execute-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        args,
                        use_sudo: useSudo
                    })
                });
                
                const data = await response.json();
                if (!isPerformanceTest) {
                    updateOutput(data);
                }
                return data;
            } catch (error) {
                const errorData = {
                    success: false,
                    message: 'Error: ' + error.message,
                    responseTime: 0
                };
                if (!isPerformanceTest) {
                    updateOutput(errorData);
                }
                return errorData;
            } finally {
                if (!isPerformanceTest) {
                    const btn = document.getElementById('projinfoCommandBtn');
                    const loadingSpinner = document.getElementById('projinfoCommandLoading');
                    btn.disabled = false;
                    btn.querySelector('span:not(#projinfoCommandLoading)').classList.remove('opacity-0');
                    loadingSpinner.classList.add('hidden');
                }
            }
        }

        // Add event listeners for all projinfo options
        document.getElementById('projinfoLong').addEventListener('change', updateProjinfoCommandPreview);
        document.getElementById('projinfoMembers').addEventListener('change', updateProjinfoCommandPreview);
        document.getElementById('projinfoXml').addEventListener('change', updateProjinfoCommandPreview);
        document.getElementById('projinfoDryRun').addEventListener('change', updateProjinfoCommandPreview);
        document.getElementById('projinfoQuiet').addEventListener('change', updateProjinfoCommandPreview);
        document.getElementById('projinfoVerbose').addEventListener('change', updateProjinfoCommandPreview);
        document.getElementById('projinfoActAs').addEventListener('input', updateProjinfoCommandPreview);

        function showSelectedCommand() {
            const command = document.getElementById('commandSelect').value;
            document.querySelectorAll('.command-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            if (command) {
                const sectionId = command + 'Section';
                document.getElementById(sectionId)?.classList.remove('hidden');
            }
            
            // Reset command preview
            const preview = document.getElementById('commandPreview');
            preview.textContent = command ? `moo ${command}` : '';
            preview.classList.remove('text-gray-900');
            preview.classList.add('text-gray-400');
            
            // Reset project names list for projinfo
            if (command !== 'projinfo') {
                projectNames.clear();
                const list = document.getElementById('projectNamesList');
                if (list) list.innerHTML = '';
            }
        }

        async function logout() {
            try {
                const response = await fetch('/admin/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                if (data.success) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error during logout:', error);
            }
        }
    </script>
</body>
</html> 